
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="copyright" content="Copyright © 2016 I.B.M. All rights reserved.

         Licensed under the Apache License, Version 2.0 (the “License”);
         you may not use this file except in compliance with the License.
         You may obtain a copy of the License at

         http://www.apache.org/licenses/LICENSE-2.0

         Unless required by applicable law or agreed to in writing, software
         distributed under the License is distributed on an “AS IS” BASIS,
         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
         See the License for the specific language governing permissions and
         limitations under the License.">
    <meta name="description" content="Watson Conversation Service Sample Application">

    <!--Tab Title-->
    <title>Watson Digital Concierge</title>

    <link rel="stylesheet" href="css/main.min.css">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="ct" content="vPWQz9kc-2sDXDdB6m_K5RLm_mwStA0c3cyo">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
</head>

<body>

<div class="box">
    <header>

        <!--Page Title-->
        <!--<div class="centered-content"><h1>Hello, Watson!</h1></div>-->

        <!--User input-->
        <div id="input-wrapper" class="content-wrapper responsive-columns-wrapper">

            <div id="input-mic-holder" class="input-element">

                <!--Micropphone Settings Button and Drop-down-->
                <div id="mic-settings-menu" class="dropdown">
                    <a id="mic-settings-button" role="button" data-toggle="dropdown" class="btn btn-default">
                        <span id="mic-settings-gear" class="glyphicon glyphicon-cog"></span>
                    </a>
                    <ul class="dropdown-menu multi-level" role="menu" aria-labelledby="dropdownMenu">
                        <li class="dropdown-submenu">
                            <a role="button">Auto-Mic: <strong>
                                <span id="auto-mic-label" data-label-placement></span></strong></a>
                            <ul id="mic-settings" class="dropdown-menu">
                                <li><input type="radio" id="always" name="mic-setting" value="always">
                                    <label for="always">Always</label></li>
                                <li><input type="radio" id="prompt" name="mic-setting" value="prompt">
                                    <label for="prompt">If Prompted</label></li>
                                <li><input type="radio" id="never" name="mic-setting" value="never">
                                    <label for="never">Never</label></li>
                            </ul>
                        </li>
                        <!--TODO: add "okay, Watson" invocation-->
                        <!--<li><a>Some other action</a></li>-->
                    </ul>
                </div>

                <!--Microphone Button-->
                <a id="mic-button"><div id="mic-image" class="inactive-mic" onclick="toggleRecognition();"></div></a>
            </div>

            <!--Text Input Field-->
            <div id="user-input-wrapper" class="input-element">
				<form onsubmit="Conversation.sendMessage(); return false;">
                  <label for="user-input" class="input-outline responsive-column">
                      <input id="user-input" type="text" placeholder="<- Press and speak or type here.">
                      <input type="submit" style="display: none">
                  </label>
                </form>
            </div>

            <!--Audio Control Button-->
            <div id="audio-control-wrapper" class="input-element">
                <a id="audio-button">
                    <div id="speaker-image" class="audio-on" onclick="TTSModule.toggle()" value="ON"></div></a>
            </div>
        </div>

    </header>
    <content>
        <!--Chat area-->
        <div id="chat-scroll-wrapper" class="content-wrapper">
            <div id="chat-flow"></div>
        </div>
    </content>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script>
  // Get mic_setting from browser localStorage
  var mic_setting = localStorage.getItem("mic_setting") || 'prompt';

  $(function() {
    $("#" + mic_setting).prop('checked', true); // set input element corresponding to the initial mic setting to checked
    $("#auto-mic-label").html($('label[for=' + mic_setting + ']').html()); // set default label based on initial mic setting
  });

  // update mic_setting variable on click
  $('#mic-settings').find('li').on('click', function() {
    mic_setting = $(this)[0].firstChild.id;
    localStorage.setItem("mic_setting", mic_setting);
  });

  var recognition = null;

  if (!('webkitSpeechRecognition' in window)) {
      //Speech API not supported here…
  } else { //Let’s do some cool stuff :)
      recognition = new webkitSpeechRecognition();
      recognition.interimResults = false;
      recognition.lang = "en-US";
      recognition.maxAlternatives = 1; //Since from our experience, the highest result is really the best...

      recognition.onstart = function() {
        //Listening (capturing voice from audio input) started.
        //This is a good place to give the user visual feedback about that (i.e. flash a red light, etc.)
        micOn();
      };

      recognition.onend = function() {
        //Again – give the user feedback that you are not listening anymore. If you wish to achieve continuous recognition – you can write a script to start the recognizer again here.
        micOff();
      };

      recognition.onspeechend = function() {
        recognition.stop();
      };

      recognition.onresult = function(recognitionEvent) { //the event holds the results
        if (typeof recognitionEvent.results === 'undefined') { //Something is wrong…
          recognition.stop();
          return;
        }

        if (recognitionEvent.results.length > 0) {
          console.log("final results: " + recognitionEvent.results[0][0].transcript);
          Api.postConversationMessage(recognitionEvent.results[0][0].transcript);
        }
      };
  }

  var mic = document.getElementById('mic-image');
  var user_input = document.getElementById('user-input');
  var recording = false;

  function toggleRecognition() {
    if(recognition === undefined) {
      return;
    }

    if(recording !== false) {
      recording = false;
      recognition.stop();
    }
    else {
      recognition.start();
    }
  }

  function micOn() {
    user_input.disabled = true;
    mic.setAttribute('class', 'active-mic');
    recording = true;
  }

  function micOff() {
    console.log("Turning off the mic.");
    user_input.disabled = false;
    mic.setAttribute('class', 'inactive-mic');
    recording = false;
  }
</script>

<script src="vendor.min.js"></script>
<script src="howler.min.js"></script>
<script src="conversation.min.js"></script>
<script src="ibm/watson-speech.min.js"></script>
<script src="ibm/text-to-speech.js"></script>

</body>

</html>
